<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>任務回報模板產生器</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
<div class="container">
    <h1>任務回報模板產生器</h1>

    <form id="report-form" onsubmit="return false;">
        <!-- 基本資訊區塊 -->
        <div class="section">
            <h2>基本資訊</h2>

            <!-- 發生時間 -->
            <div class="form-row">
                <label for="incident_date">發生時間：</label>
                <input
                    type="date"
                    id="incident_date"
                    name="incident_date"
                    value="{{ default_date }}"
                    required
                />
            </div>

            <!-- 測試者（autocomplete） -->
            <div class="form-row">
                <label for="tester">測試者：</label>
                <div class="autocomplete-wrapper">
                    <input
                        type="text"
                        id="tester"
                        name="tester"
                        class="memory-input"
                        data-memory-key="tester"
                    />
                    <div class="suggestions"></div>
                </div>
            </div>

            <!-- 版本（autocomplete） -->
            <div class="form-row">
                <label for="version">版本：</label>
                <div class="autocomplete-wrapper">
                    <input
                        type="text"
                        id="version"
                        name="version"
                        class="memory-input"
                        data-memory-key="version"
                    />
                    <div class="suggestions"></div>
                </div>
            </div>

            <!-- 站別（下拉） -->
            <div class="form-row">
                <label for="site">站別：</label>
                <select id="site" name="site">
                    <option value="QA站" selected>QA站</option>
                    <option value="PROD站">PROD站</option>
                </select>
            </div>

            <!-- 測試廳主／帳號 -->
            <div class="form-row">
                <label>測試廳主／帳號：</label>
                <select id="hall" name="hall">
                    <option value="Tidy遊戲商測試廳" selected>Tidy遊戲商測試廳</option>
                    <option value="Tidy遊戲級距測試廳">Tidy遊戲級距測試廳</option>
                    <option value="DB TEST">DB TEST</option>
                </select>
                <span class="slash">/</span>

                <div class="autocomplete-wrapper inline">
                    <input
                        type="text"
                        id="account"
                        name="account"
                        class="memory-input"
                        data-memory-key="account"
                    />
                    <div class="suggestions"></div>
                </div>
            </div>

            <!-- 裝置 + iOS 瀏覽器 -->
            <div class="form-row">
                <label for="device">裝置：</label>
                <select id="device" name="device">
                    <option value="PC" selected>PC</option>
                    <option value="Android">Android</option>
                    <option value="iOS">iOS</option>
                </select>

                <div id="ios-browser-wrapper" class="ios-browser-wrapper">
                    <span class="slash">/</span>
                    <select id="ios_browser" name="ios_browser">
                        <option value="Chrome" selected>Chrome</option>
                        <option value="Safari">Safari</option>
                    </select>
                </div>
            </div>

            <!-- 注單編號 -->
            <div class="form-row">
                <label for="order_id">注單編號：</label>
                <input
                    type="text"
                    id="order_id"
                    name="order_id"
                />
            </div>
        </div>


        <!-- 描述內容區 -->
        <div class="section">
            <h2>描述內容（可貼圖片）</h2>

            <div class="form-row vertical">
                <label for="operation_editor">操作：</label>
                <div id="operation_editor"
                    class="rich-editor large"
                    contenteditable="true"
                    placeholder="可輸入文字／貼上圖片">
                </div>
            </div>

            <div class="form-row vertical">
                <label for="actual_editor">實際結果：</label>
                <div id="actual_editor"
                    class="rich-editor large"
                    contenteditable="true"
                    placeholder="可輸入文字／貼上圖片">
                </div>
            </div>

            <div class="form-row vertical">
                <label for="expected_editor">預期結果：</label>
                <div id="expected_editor"
                    class="rich-editor large"
                    contenteditable="true"
                    placeholder="可輸入文字／貼上圖片">
                </div>
            </div>

            <div class="form-row vertical">
                <label for="remark_editor">備註：</label>
                <div id="remark_editor"
                    class="rich-editor medium"
                    contenteditable="true"
                    placeholder="可輸入文字／貼上圖片">
                </div>
            </div>
        </div>

        <!-- 按鈕區（只剩一鍵複製） -->
        <div class="button-row">
            <button type="button" id="copy-btn">一鍵複製</button>
        </div>
    </form>

    <!-- 純文字預覽 -->
    <div class="section output-section">
        <h2>文字預覽</h2>
        <textarea id="preview-text" readonly rows="16"></textarea>
    </div>

</div>

<script>
    /*------------------------------
      iOS 顯示瀏覽器下拉
    -------------------------------*/
    function updateIOSBrowserVisibility() {
        const device = document.getElementById("device").value;
        const wrapper = document.getElementById("ios-browser-wrapper");
        wrapper.style.display = (device === "iOS") ? "inline-flex" : "none";
    }

    /*------------------------------
      autocomplete 記憶邏輯
    -------------------------------*/
    function setupMemoryInputs() {
        document.querySelectorAll(".memory-input").forEach(input => {
            const key = input.dataset.memoryKey;
            let items = loadMemory(key);

            const wrapper = input.closest(".autocomplete-wrapper");
            const list = wrapper.querySelector(".suggestions");

            input.addEventListener("focus", () => renderSuggestions(input, list, items, ""));
            input.addEventListener("input", () => renderSuggestions(input, list, items, input.value));

            input.addEventListener("blur", () => {
                const v = input.value.trim();
                if (v && !items.includes(v)) {
                    items.push(v);
                    saveMemory(key, items);
                }
                setTimeout(() => list.style.display = "none", 150);
            });
        });
    }

    function loadMemory(key) {
        try {
            return JSON.parse(localStorage.getItem("memory_" + key)) || [];
        } catch {
            return [];
        }
    }

    function saveMemory(key, arr) {
        localStorage.setItem("memory_" + key, JSON.stringify(arr));
    }

    function renderSuggestions(input, box, arr, filter) {
        const keyword = filter.trim().toLowerCase();
        const tmp = keyword ? arr.filter(x => x.toLowerCase().includes(keyword)) : arr;

        if (!tmp.length) {
            box.style.display = "none";
            return;
        }

        box.innerHTML = "";
        tmp.forEach(v => {
            const d = document.createElement("div");
            d.className = "suggestion-item";
            d.textContent = v;
            d.addEventListener("mousedown", () => {
                input.value = v;
                box.style.display = "none";
                buildPlainTextPreview();
            });
            box.appendChild(d);
        });
        box.style.display = "block";
    }


    /*------------------------------
      ★ 生成純文字預覽（最重要）
    -------------------------------*/
    function buildPlainTextPreview() {
        const pv = document.getElementById("preview-text");

        const incidentDate = document.getElementById("incident_date").value || "";
        const tester = document.getElementById("tester").value || "";
        const version = document.getElementById("version").value || "";
        const site = document.getElementById("site").value || "";
        const hall = document.getElementById("hall").value || "";
        const account = document.getElementById("account").value || "";
        const device = document.getElementById("device").value || "";
        const iosBrowser = document.getElementById("ios_browser").value || "";
        const orderId = document.getElementById("order_id").value || "";

        const op = document.getElementById("operation_editor").innerText.trim();
        const act = document.getElementById("actual_editor").innerText.trim();
        const exp = document.getElementById("expected_editor").innerText.trim();
        const remark = document.getElementById("remark_editor").innerText.trim();

        let deviceLine = "裝置：" + device;
        if (device === "iOS") deviceLine += " / " + iosBrowser;

        const lines = [
            `發生時間：${incidentDate}`,
            `測試者：${tester}`,
            `版本：${version}`,
            `站別：${site}`,
            `測試廳主／帳號：${hall} / ${account}`,
            deviceLine,
            `注單編號：${orderId}`,
            "",
            "操作：",
            op,
            "",
            "實際結果：",
            act,
            "",
            "預期結果：",
            exp,
            "",
            "備註：",
            remark,
        ];

        pv.value = lines.join("\n");
    }


    /*------------------------------
      ★ 一鍵複製（純文字）
    -------------------------------*/
    function copyPlainText() {
        const txt = document.getElementById("preview-text").value;
        navigator.clipboard.writeText(txt)
            .then(() => alert("已複製純文字到剪貼簿"))
            .catch(() => {
                const area = document.getElementById("preview-text");
                area.select();
                document.execCommand("copy");
                alert("已複製純文字到剪貼簿");
            });
    }


    /*------------------------------
      初始化
    -------------------------------*/
    window.addEventListener("DOMContentLoaded", () => {
        updateIOSBrowserVisibility();
        setupMemoryInputs();

        // 一般欄位即時預覽
        [
            "incident_date","tester","version","site",
            "hall","account","order_id","device","ios_browser"
        ].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener("input", buildPlainTextPreview);
            el.addEventListener("change", buildPlainTextPreview);
        });

        // rich-editor 欄位即時預覽
        [
            "operation_editor","actual_editor",
            "expected_editor","remark_editor"
        ].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener("input", buildPlainTextPreview);
            el.addEventListener("keyup", buildPlainTextPreview);
        });

        // 一鍵複製
        document.getElementById("copy-btn").addEventListener("click", copyPlainText);

        // 初次載入先生成一次預覽
        buildPlainTextPreview();
    });
</script>

</body>
</html>
