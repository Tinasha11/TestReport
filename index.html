<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>任務回報模板產生器</title>

    <style>
        /* ====== 基本頁面樣式 ====== */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px 24px 32px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        h1 {
            text-align: center;
            margin: 0 0 1.2rem 0;
            font-size: 1.6rem;
        }

        h2 {
            font-size: 1.1rem;
            border-left: 4px solid #4a90e2;
            padding-left: 8px;
            margin: 1.5rem 0 .8rem 0;
        }

        .section,
        .title-section {
            background-color: #fafafa;
            padding: 12px 14px 16px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        /* ====== 表單列 ====== */
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.7rem;
            gap: 8px;
        }

        .form-row.vertical {
            flex-direction: column;
            align-items: flex-start;
        }

        .form-row label {
            min-width: 120px;
            font-weight: 500;
        }

        
        /* 讓裝置區塊在 form-row 中撐滿剩餘寬度（Android 瀏覽器版本可延伸至最右側） */
        .device-group {
            flex: 1;
            min-width: 0; /* 避免 flex 子項被內容撐爆 */
            max-width: 696px; /* 比照 iOS 其他區塊的實際右緣（120+260+300+gap*2） */ /* 與 iOS 其他區塊的寬度一致，避免過寬 */
        }
        .device-group .device-row {
            width: 100%;
        }
/* ====== 基本 input 樣式 ====== */
        input[type="text"],
        input[type="date"],
        select,
        textarea {
            font-size: 0.95rem;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        /* ====== menu-only inputs（僅選單，不允許鍵盤輸入） ====== */
        .menu-only{
            caret-color: transparent;
            cursor: pointer;
        }
        .menu-only::selection{ background: transparent; }


        textarea {
            width: 100%;
            resize: vertical;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            font-variant-east-asian: proportional-width;
        }

        /* ====== 富文字編輯器 ====== */
        .rich-editor {
            width: 100%;
            border-radius: 6px;
            border: 1px solid #ccc;
            padding: 6px 8px;
            background-color: #fff;
            overflow-y: auto;
            font-size: .95rem;
        }
        .rich-editor.large { min-height: 140px; }
        .rich-editor.medium { min-height: 80px; }

        /* ====== autocomplete wrapper ====== */
        .autocomplete-wrapper {
            position: relative;
            flex: 1;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 50;
        }

        .suggestion-item {
            padding: 6px 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #e6f2ff;
        }

        #title-preview {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            font-variant-east-asian: proportional-width;
        }

        #full-preview {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            font-variant-east-asian: proportional-width;
            background-color: #fdfdfd;
        }

        /* ====== 裝置欄位（保持原樣） ====== */
        .device-row {
            display: grid;
            grid-template-columns: 120px 300px 300px;
            align-items: center;
            gap: 8px;
        }

        #pc-row {
            grid-template-columns: 120px 300px;
        }

        #ios-row {
            grid-template-columns: 120px 300px;
        }

        /* ====== ⭐ iOS 子選項（正式修改版） ====== */

        /* Safari / Chrome / 其他整組左移，與你圖片一致 */
        #ios-browser-wrapper {
            margin-left: 80px;   /* 你測試後確定的值 */
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Safari / Chrome — 左 120px（checkbox + label）、右側 260px（輸入欄位） */
        .ios-browser-group .device-row {
            display: grid;
            grid-template-columns: 120px 260px; /* 你手動試出的完美比例 */
            gap: 8px;
        }

        /* ====== 其他（Other）三欄，只調整這行，不影響 Safari/Chrome ====== */
        .ios-extra-row {
            display: grid;
            grid-template-columns: 120px 260px 220px; /* 完全對齊 Safari/Chrome + Android */
            gap: 8px;
        }

        /* “瀏覽器（例：Edge）” 欄位 → 和 Safari/Chrome 一樣寬 */
        #ios-other-name {
            width: 260px;       /* ❗ 不加 !important 才不會干到其他欄位 */
        }

        /* “例：121.0” 欄位 → 位置後退，寬度固定 300px */
        #ios-other-version {
            width: 300px;       /* ❗ 精準對齊 Android 的瀏覽器欄位 */
        }

        /* === 覆寫按鈕 UI（依照你的圖片樣式）=== */
        .button-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
        }

        .button-row button {
            padding: 10px 26px;
            border-radius: 999px;
            border: none;
            background-color: #4a90e2;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s ease-in-out;
        }

        .button-row button:hover {
            background-color: #357bd8;
        }

        .button-row button:active {
            transform: scale(0.96);
        }

        #problem-desc {
            width: 735px !important;
        }        

        #bug_def {
            width: 644px !important;
        }

    
        /* ====== 已選遊戲（橫向 chip 樣式） ====== */
        #selected-games {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }



        /* ====== 遊戲搜尋欄位：寬度跟著文字（避免 placeholder 被截斷，也不留多餘空白） ====== */
        #game-select{
            display: inline-block;
            width: auto;        /* 實際寬度由 JS 量測後設定 */
            max-width: 100%;
        }

        /* ====== 已選站別（chip 顯示在選擇欄位右側） ====== */
        .site-inline-select{
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        .site-select-wrap{
            width: 220px;
            flex: 0 0 auto;
            position: relative;
        }
        .site-select-wrap input{ width: 100%; }
        #selected-sites{
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 28px;
            align-content: flex-start;
            margin-top: 0px;
            flex: 1;
            min-width: 0;
        }

        /* === 站別與站別設定區塊之間更緊密 === */
        .form-row:has(.site-inline-select){
            margin-bottom: 0.35rem;
        }
        .form-row:has(#site-config-container){
            margin-top: 0px;
        }


        .game-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #e6f2ff;
            color: #1f4fa3;
            font-size: 0.85rem;
        }
        .game-chip button {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.9rem;
            line-height: 1;
            color: #1f4fa3;
        }
        .game-chip button:hover {
            color: #c00;
        }




        /* ====== 站別設定區塊（與 chip 樣式做區隔） ====== */
        .site-config-container{ margin-top: 2px; width: 100%; }

        .site-config-card{
            background: #ffffff;
            border: 1px solid #e6e6e6;
            border-radius: 10px;
            padding: 10px 12px;
            margin: 8px 0 10px;
        }

        .site-config-header{
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        /* 站別標題：用「小標籤/章節」風格，避免和 chip（藍色膠囊）長得一樣 */
        .site-config-title{
            font-weight: 700;
            font-size: 0.92rem;
            color: #2b2b2b;
            background: #f3f3f3;
            border: 1px solid #e3e3e3;
            border-left: 4px solid #4a90e2;
            padding: 4px 10px;
            border-radius: 8px;
            line-height: 1.1;
        }

        .site-config-row{
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 2px;
        }
        .site-config-row label{
            min-width: 120px;
            font-weight: 500;
            padding-top: 6px;
        }

        .site-config-row .autocomplete-wrapper{ flex: 1; min-width: 0; }

        .site-config-row .field{ flex: 1; min-width: 0; }

        /* 站別/廳主/帳號的多選 chip 容器：預留一行高度，避免推擠 */
        .selected-chips{
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 26px; /* 預留一行 chip 高度：避免加入後微推擠 */
            align-content: flex-start;
        }

        /* 每站別：廳主/帳號一對一綁定 UI */
        .pair-add-line{
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .pair-add-line .pair-hall-wrap{ width: 260px; flex: 0 0 auto; }
        .pair-add-line .pair-account-wrap{ width: 240px; flex: 0 0 auto; }
        /* 試玩模式：保留帳號欄寬度以對齊版面，但不顯示內容 */
        .trial-empty{
            visibility: hidden;
            pointer-events: none;
        }
        .pair-add-line button{
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #cfd8e3;
            background: #f7f9fc;
            cursor: pointer;
        }
        .pair-add-line button:hover{ background:#eef3fb; }

        /* 每站別：版本（遊戲版本 / 投注歷程版本） */
        /* 目標：勾選後出現輸入框時不推擠膠囊高度 → 先預留輸入框高度 */
        .site-version-block{
            margin-top: 4px; /* 更緊密 */
            display: flex;
            flex-direction: column;
            gap: 4px; /* 更緊密 */
        }
        .site-version-line{
            /* 讓兩個輸入框起點完全對齊：固定第一欄寬度 */
            display: grid;
            grid-template-columns: 150px 300px;
            align-items: center;
            column-gap: 10px;
        }
        .site-version-line label{
            width: 150px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0;
            white-space: nowrap;
        }
        .site-version-line .autocomplete-wrapper{
            width: 300px;
            flex: 0 0 auto;
            min-width: 0;
            display: block; /* 永遠保留佔位，避免勾選後推擠 */
        }
        .site-version-line .autocomplete-wrapper.v-hidden{
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }

        /* 站別輸入框短一點：右側留給已選 chip */
        .site-select-wrap{ width: 220px; }
        .site-select-wrap input{ width: 100%; }

        /* ====== ✅ 新增：裝置型號欄位 ====== */
        .device-row.with-model {
            grid-template-columns: 120px 220px 1fr;
        }
        .device-row.android.with-model {
            grid-template-columns: 120px 220px 140px 1fr;
        }
        
        /* Android：讓各欄位 input 充滿各自的 grid 欄位，避免視覺間距不一致 */
        .device-row.android.with-model .autocomplete-wrapper,
        .device-row.android.with-model input[type="text"]{
            width: 100%;
        }
        .device-row.android.with-model .autocomplete-wrapper input[type="text"]{
            width: 100%;
        }
/* PC 原本兩欄，改為三欄（label + 型號 + 瀏覽器） */
        #pc-row.with-model {
            grid-template-columns: 120px 220px 1fr;
        }
        /* iOS 原本兩欄，改為三欄（label + OS + 型號） */
        #ios-row.with-model {
            grid-template-columns: 120px 220px 140px;
        }


        
        /* iOS：避免型號被截短（讓型號欄位可伸縮並撐滿） */
        #ios-row.with-model .autocomplete-wrapper,
        #ios-row.with-model .autocomplete-wrapper input[type="text"]{
            width: 100%;
        }
/* ====== 修正：iOS 型號 / 系統版本需同一列 ====== */
        .device-row.with-model .autocomplete-wrapper {
            flex: 0;
            width: auto;
        }


        /* ====== ✅ 固定：保持 index_fixed7 的高度/間距，並讓「版本」輸入框寬度比照 PC/Android 欄位 ====== */
        /* 目標：
           - 保持 fixed7：兩行版本之間 gap=0、輸入框用 visibility 切換避免推擠
           - 版本輸入框寬度改為與 PC/Android 的單一欄位寬度一致（300px）
        */

        :root{
            --std-field-w: 300px; /* PC/Android 欄位的標準寬度（device-row 的 300px 欄位） */
        }

        /* fixed7：只覆寫版本那一列的 column gap（原本 inline gap:10px 會讓兩行行距過大） */
        .form-row:has(#version-game-check) > div[style*="flex-direction:column"]{
            gap: 0 !important;
        }

        /* fixed7：版本輸入框固定佔位（不推擠） */
        #version-game-wrapper,
        #version-bet-wrapper{
            display: block !important;      /* 覆寫 inline display:none */
            flex: 0 0 var(--std-field-w);   /* ✅ 寬度比照 PC/Android */
            width: var(--std-field-w);
            min-width: 0;
        }
        #version-game,
        #version-bet{
            width: 100%;                    /* 充滿上面的 300px wrapper */
            min-width: 0;
        }

        /* 未勾選：隱藏但保留空間（不推擠） */
        label:has(#version-game-check:not(:checked)) + #version-game-wrapper,
        label:has(#version-bet-check:not(:checked)) + #version-bet-wrapper{
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        /* 勾選：顯示 */
        label:has(#version-game-check:checked) + #version-game-wrapper,
        label:has(#version-bet-check:checked) + #version-bet-wrapper{
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

</style>

<style>
select option[disabled]{display:none;}
</style>
</head>
<body autocomplete="off">
<div class="container">
    <h1>任務回報模板產生器</h1>

    <!-- 任務標題 -->
    <div class="title-section">
        <h2>任務標題</h2>

        <!-- 遊戲 -->
        <div class="form-row">
            <label>遊戲：</label>
            <div class="autocomplete-wrapper">
                <input type="text" id="game-select" autocomplete="new-password" name="nohistory-game"
                     placeholder="搜尋遊戲（GameCode或名稱），可複選">
                <div class="suggestions" id="game-suggestions"></div>
                <div id="selected-games" style="margin-top:6px;font-size:0.9rem;color:#333;"></div>
            </div>
        </div>

        <!-- 問題描述 -->
        <div class="form-row">
            <label>問題描述：</label>
            <input type="text" id="problem-desc" autocomplete="new-password" name="nohistory-desc"
                placeholder="簡述本次問題">
        </div>
    </div>

    <!-- 基本資訊 -->
    <div class="section">
        <h2>基本資訊</h2>

        <div class="form-row">
            <label>發生時間：</label>
            <input type="date" id="incident_date" autocomplete="new-password" name="nohistory-date">
        </div>

        <div class="form-row">
            <label>測試者：</label>
            <div class="autocomplete-wrapper">
                <input type="text" id="tester" class="memory-input"
                    data-memory-key="tester" autocomplete="new-password" name="nohistory-tester">
                <div class="suggestions"></div>
            </div>
        </div>
        <div class="form-row">
            <label>站別：</label>
            <div class="site-inline-select">
                <div class="autocomplete-wrapper site-select-wrap">
                    <input type="text" id="site-select" class="menu-only" readonly inputmode="none" autocomplete="new-password" name="nohistory-site"
                        placeholder="搜尋站別，可複選">
                    <div class="suggestions" id="site-suggestions"></div>
                </div>
                <div id="selected-sites"></div>
            </div>
        </div>

        <div class="form-row">
            <label>測試廳主／帳號：</label>
            <div id="site-config-container" class="site-config-container"></div>
        </div>

        <!-- 裝置 -->
        <div class="form-row">
            <label>裝置：</label>

            <div class="device-group">
                <!-- PC -->
                <div class="device-row" id="pc-row">
                    <label><input type="checkbox" class="device-check"
                        value="PC" id="device-pc"> PC</label>
<input type="text" id="pc-browser" autocomplete="new-password" name="nohistory-pcb"
                        class="browser-input" placeholder="瀏覽器版本">
                </div>

                <!-- Android -->
                <div class="device-row android with-model"><label><input type="checkbox" class="device-check"
                        value="Android" id="device-android"> Android</label>
                    <div class="autocomplete-wrapper">
                        <input type="text" id="android-model" data-memory-key="android_model" autocomplete="new-password" name="nohistory-am"
                        class="model-input memory-input" placeholder="裝置型號（非必要可略過）">
                        <div class="suggestions"></div>
                    </div>
                    <input type="text" id="android-os" autocomplete="new-password" name="nohistory-aos"
                        class="os-input" placeholder="系統版本">
                    <input type="text" id="android-browser" autocomplete="new-password" name="nohistory-ab"
                        class="browser-input" placeholder="瀏覽器版本">
                </div>

                <!-- iOS -->
                <div class="device-row with-model" id="ios-row">
                    <label><input type="checkbox" class="device-check"
                        value="iOS" id="ios-check"> iOS</label>
                    
                    <div class="autocomplete-wrapper">
                        <input type="text" id="ios-model" data-memory-key="ios_model" autocomplete="new-password" name="nohistory-im"
                        class="model-input memory-input" placeholder="裝置型號（非必要可略過）">
                        <div class="suggestions"></div>
                    </div>
                    <input type="text" id="ios-os" autocomplete="new-password" name="nohistory-ios"
                        class="os-input" placeholder="系統版本">
                    
                </div>
            </div>
        </div>

        <!-- iOS 子欄位（已套用你要求的左移 + 寬度調整） -->
        <div class="form-row" id="ios-browser-wrapper" style="display:none;">
            <div class="ios-browser-group">

                <div class="device-row">
                    <label><input type="checkbox" class="ios-browser" id="ios-safari">
                        Safari</label>
                    <input type="text" id="ios-safari-version" autocomplete="new-password" name="nohistory-isv"
                        class="browser-version-input" placeholder="Safari版本為iOS版本" readonly style="background:#ddd;color:#555;">
                </div>

                <div class="device-row">
                    <label><input type="checkbox" class="ios-browser" id="ios-chrome">
                        Chrome</label>
                    <input type="text" id="ios-chrome-version" autocomplete="new-password" name="nohistory-icv"
                        class="browser-version-input" placeholder="瀏覽器版本">
                </div>

                <div class="ios-extra-row">
                    <label>其他：</label>
                    <input type="text" id="ios-other-name" autocomplete="new-password" name="nohistory-ion"
                        class="browser-name-input" placeholder="瀏覽器（例：Edge）">
                    <input type="text" id="ios-other-version" autocomplete="new-password" name="nohistory-iov"
                        class="browser-version-input" placeholder="瀏覽器版本">
                </div>

            </div>
        </div>

        <div class="form-row">
            <label>注單編號：</label>
            <input type="text" id="order_id" autocomplete="new-password" name="nohistory-order" placeholder="未有注單可跳過">
        </div>
    </div>
    <!-- 描述內容 -->
    <div class="section">
        <h2>描述內容</h2>

        <div class="form-row vertical">
            <label>操作：</label>
            <div id="operation_editor" class="rich-editor large"
                contenteditable="true"></div>
        </div>

        <div class="form-row vertical">
            <label>實際結果：</label>
            <div id="actual_editor" class="rich-editor large"
                contenteditable="true"></div>
        </div>

        <div class="form-row vertical">
            <label>預期結果：</label>
            <div id="expected_editor" class="rich-editor large"
                contenteditable="true"></div>
        </div>

        <div class="form-row vertical">
            <label>備註：</label>
            <div id="remark_editor" class="rich-editor medium"
                contenteditable="true"></div>
        </div>
    </div>

    <!-- 按鈕 -->
    <div class="button-row">
        <button id="copy-title-btn">複製標題</button>
        <button id="copy-btn">一鍵複製</button>
    </div>

    <!-- 預覽 -->
    <div class="section">
        <h2>文字預覽</h2>
        <input type="text" id="title-preview" readonly>
        <textarea id="full-preview" rows="16" readonly></textarea>
    </div>
</div>

<!-- ===================== JS ======================= -->
<script>
/* 設定今日日期 */
function setToday(){
    const d=document.getElementById("incident_date");
    const today=new Date().toISOString().split("T")[0];
    d.value=today;
    d.max=today;
}

/* 遊戲清單 */
const gameList=[["Game101","瘋狂實驗室"],["Game102","開運金獅"],["Game103","星際冒險"],
["Game104","精靈奇園"],["Game105","功夫高手"],["Game106","淘金樂"],["Game107","國王的祕寶"],
["Game108","南極世界"],["Game109","荒野大西部"],["Game110","超級猴子"],["Game111","刺客密令"],
["Game112","白蛇傳"],["Game113","美味一番"],["Game114","幸運派翠克"],["Game115","魚蝦蟹 slot"],
["Game116","叱吒西遊"],["Game117","鬥士傳奇"],["Game118","小紅帽:送餐大作戰"],["Game119","威震公堂"],
["Game120","魔法學園"],["Game122","發大柴"],["Game139","金福瑞獸"],["Game123","巨獸金剛"],
["Game124","刮刮樂"],["Game125","奇門遁甲"],["Game126","泰濕控"],["Game127","暹羅神拳"],
["Game128","哥布林礦坑"],["Game129","湖中女神"],["Game130","古墓驚魂"],["Game131","絕世神偷"],
["Game132","羅摩衍那"],["Game133","骰寶"],["Game134","百家樂"],["Game135","5PK"],
["Game136","水果樂園"],["Game137","遠古生物"],["Game138","魔豆"],["Game121","21點"],
["Game140","神醫百草傳"],["Game141","龍宮寶藏"],["Game142","維京傳奇"],["Game143","大笑彌勒"],
["Game144","日輪寶殿"],["Game145","要塞爭奪戰"],["Game146","永恆之吻"],["Game147","龍門試練"],
["Game148","非洲獅王"],["Game149","迎財神"],["Game150","撒哈拉奇緣"],["Game151","牛牛娶親"],
["Game152","金牛發發發"],["Game153","馬雅末日"],["Game154","野性的渴望"],["Game155","搗蛋好來屋"],
["Game156","招財聚寶"],["Game157","加勒比奇航"],["Game158","伯利恆之星"],["Game159","添運財神"],
["Game160","三國群雄"],["Game161","JP麻將胡了"],["Game162","敲吉鼠"],["Game163","786 SLOT"],
["Game164","龍珠 ‧ 天命"],["Game165","刮刮樂2 龍耀無限"],["Game166","刮刮樂3 羊羊derE"],
["Game167","埃及祕寶"],["Game168","擊鼓迎福"],["Game169","EDM迷幻"],["Game170","四象拱財"],
["Game171","巫毒傳說"],["Game172","花開富貴"],["Game173","速度與激情"],["Game174","花式5PK"],
["Game175","福虎臨門"],["Game176","超級射門"],["Game177","DICE"],["Game178","鳳凰傳說"],
["Game179","伊甸王座"],["Game180","電音兔兔"],["Game181","吐鈔機"],["Game182","迎財神 2"],
["Game183","添運財神2"],["Game184","黃金麻將"],["Game185","金銀鯉"],["Game186","星海征戰"],
["Game187","轟蜜大作戰"],["Game188","烽起雲湧時"],["Game189","海洋物語"],["Game190","命運之手"],
["Game191","爆焰足球"],["Game192","好運金蟾"],["Game193","F.T.G榮耀前線"],["Game194","拉密"],
["Game195","武神趙子龍"],["Game196","牛轉錢坤"],["Game197","東郊皇陵"],["Game198","武聖關羽"],
["Game199","惡魔甜心"],["Game200","天使寶貝"],["Game201","JP麻將胡了2"],["Game202","星爆宇宙"],
["Game203","點蛇成金"],["Game204","封神傳奇"],["Game205","開門大吉"],["Game206","牛轉錢坤2"],
["Game207","虎嘯龍吟"],["Game208","射龍門"],["Game209","添運財神3"],["Game210","皇家老虎機"],
["Game211","財神妙"],["Game212","Lucky Guess"],["Game213","金豪鯉"],["Game214","賽馬娘"],
["Game215","X型連爆中式"]];

/* --- autocomplete 遊戲搜尋（✅ 複選版） --- */
const gameInput=document.getElementById("game-select");
const gameSuggest=document.getElementById("game-suggestions");

// ====== 遊戲搜尋欄位自動調整寬度（依 placeholder / 輸入內容量測） ======
function _measureTextWidth(text, el){
    const cs = getComputedStyle(el);
    const font = `${cs.fontStyle} ${cs.fontVariant} ${cs.fontWeight} ${cs.fontSize} / ${cs.lineHeight} ${cs.fontFamily}`;
    const canvas = _measureTextWidth._c || (_measureTextWidth._c = document.createElement('canvas'));
    const ctx = canvas.getContext('2d');
    ctx.font = font;
    return ctx.measureText(text || '').width;
}

function _autoSizeInputToText(inputEl, text){
    const cs = getComputedStyle(inputEl);
    const pad = (parseFloat(cs.paddingLeft)||0) + (parseFloat(cs.paddingRight)||0);
    const border = (parseFloat(cs.borderLeftWidth)||0) + (parseFloat(cs.borderRightWidth)||0);
    let w = Math.ceil(_measureTextWidth(text, inputEl) + pad + border + 2); // +2: 保險避免被吃字

    // 不要超過父容器寬度
    const parent = inputEl.parentElement;
    if(parent){
        const max = parent.clientWidth;
        if(max && w > max) w = max;
    }
    // 避免太窄
    if(w < 120) w = 120;

    inputEl.style.width = w + 'px';
}

function autoSizeGameInput(){
    if(!gameInput) return;
    const text = (gameInput.value && gameInput.value.trim()) ? gameInput.value : gameInput.placeholder;
    _autoSizeInputToText(gameInput, text);
}


let selectedGames = []; // [{id,name}]

// 初始 + 互動時自動調整欄位寬度
autoSizeGameInput();
gameInput.addEventListener('input', autoSizeGameInput);
window.addEventListener('resize', () => {
    // 讓 reflow 後再量測一次
    requestAnimationFrame(autoSizeGameInput);
});


function renderSelectedGames(){
    const box = document.getElementById("selected-games");
    box.innerHTML = "";
    selectedGames.forEach((g, idx) => {
        const chip = document.createElement("div");
        chip.className = "game-chip";
        chip.textContent = `${g.id} ${g.name}`;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "×";
        btn.addEventListener("click", () => {
            selectedGames.splice(idx, 1);
            renderSelectedGames();
            updateTitle();
        });

        chip.appendChild(btn);
        box.appendChild(chip);
    });
}

function renderGameList(keyword=""){
    const kw=keyword.toLowerCase();
    gameSuggest.innerHTML="";

    const matches=gameList.filter(([id,name]) =>
        id.toLowerCase().includes(kw) || name.toLowerCase().includes(kw)
    );

    // 清除全部
    const blankDiv = document.createElement("div");
    blankDiv.className = "suggestion-item";
    blankDiv.textContent = "(清除全部)";
    blankDiv.addEventListener("mousedown", () => {
        selectedGames = [];
        gameInput.value = "";
        autoSizeGameInput();
        renderSelectedGames();
        gameSuggest.style.display = "none";
        updateTitle();
    });
    gameSuggest.appendChild(blankDiv);

    matches.forEach(([id,name])=>{
        const div=document.createElement("div");
        div.className="suggestion-item";
        div.textContent=`${id} ${name}`;
        div.addEventListener("mousedown",()=>{
            if(!selectedGames.find(g => g.id === id)){
                selectedGames.push({id,name});
            }
            gameInput.value = "";
            autoSizeGameInput();
            renderSelectedGames();
            gameSuggest.style.display="none";
            updateTitle();
        });
        gameSuggest.appendChild(div);
    });

    gameSuggest.style.display = matches.length ? "block":"none";
}

gameInput.addEventListener("focus",()=>renderGameList(""));
gameInput.addEventListener("input",()=>{
    renderGameList(gameInput.value);
});
document.addEventListener("click",(e)=>{
    if(!gameInput.contains(e.target)) gameSuggest.style.display="none";
});



/* --- 符號全形化（僅轉換 ASCII 符號） --- */
function toFullWidthSymbols(str){
    if (str == null) return "";
    return String(str)
        .replace(/\\/g, "＼")
        .replace(/\//g, "／")
        .replace(/_/g, "＿")
        .replace(/-/g, "－")
        .replace(/:/g, "：")
        .replace(/;/g, "；")
        .replace(/,/g, "，")
        .replace(/\./g, "．")
        .replace(/\?/g, "？")
        .replace(/!/g, "！")
        .replace(/\(/g, "（")
        .replace(/\)/g, "）")
        .replace(/\[/g, "［")
        .replace(/\]/g, "］")
        .replace(/\{/g, "｛")
        .replace(/\}/g, "｝")
        .replace(/</g, "＜")
        .replace(/>/g, "＞")
        .replace(/\+/g, "＋")
        .replace(/=/g, "＝")
        .replace(/\*/g, "＊")
        .replace(/@/g, "＠")
        .replace(/#/g, "＃")
        .replace(/%/g, "％")
        .replace(/&/g, "＆")
        .replace(/\^/g, "＾")
        .replace(/\|/g, "｜")
        .replace(/"/g, "＂")
        .replace(/'/g, "＇")
        .replace(/~/g, "～")
        // 日期維持半形連字號（YYYY-MM-DD）
        .replace(/(\d{4})－(\d{2})－(\d{2})/g, "$1-$2-$3");
}
/* --- 標題生成 --- */
function updateTitle(){
    const desc=document.getElementById("problem-desc").value.trim();
    let result="";

    if (selectedGames.length){
        const gamePart = selectedGames.map(g => {
            const id = g.id.replace('Game','');
            return `${id}_${g.name}`;
        }).join("、");

        result = desc ? `${gamePart}_${desc}` : gamePart;
    } else if (desc){
        result = desc;
    }

    document.getElementById("title-preview").value = toFullWidthSymbols(result);
    updateFullPreview();
}
document.getElementById("problem-desc").addEventListener("input",updateTitle);

/* --- 智能 OS 補字首 --- */
function formatOS(prefix, value){
    value = value.trim();
    if (!value) return "";
    return `${prefix} ${value}`;
}

/* --- 智能瀏覽器判斷（PC / Android 共用） --- */
function formatBrowser(value){
    const v = value.trim();
    if (!v) return "";

    if (!/^[0-9.]+$/.test(v)){
        return `瀏覽器：${v}`;
    }
    return `瀏覽器：Chrome ${v}`;
}

/* --- 裝置資料組裝（回傳每裝置一行字串） --- */

function getDeviceLines(){
    const lines = [];

    // 去除 formatBrowser() 可能自帶的「瀏覽器：」前綴
    const normBrowser = (s) => (s || "").replace(/^瀏覽器：\s*/, "").trim();
    const joinSlash = (arr) => arr.filter(Boolean).join("／");

    const pcOn = document.getElementById("device-pc").checked;
    const androidOn = document.getElementById("device-android").checked;
    const iosOn = document.getElementById("ios-check").checked;

    const total = (pcOn?1:0) + (androidOn?1:0) + (iosOn?1:0);

    // PC 詳細：Chrome 111
    const getPC = () => {
        const br = normBrowser(formatBrowser(document.getElementById("pc-browser").value));
        return br || ""; // 允許空
    };

    // Android 詳細：Android 456／Chrome 789（如有型號則：Pixel 7／Android 456／Chrome 789）
    const getAndroid = () => {
        const model = (document.getElementById("android-model").value || "").trim();
        const osVal = (document.getElementById("android-os").value || "").trim();
        const br = normBrowser(formatBrowser(document.getElementById("android-browser").value));

        const platform = osVal ? `Android ${osVal}` : "Android";
        const parts = [];
        if (model) parts.push(model);
        parts.push(platform);
        if (br) parts.push(br);

        return joinSlash(parts);
    };

    // iOS 詳細：iOS 222／Safari 222、Chrome 333、Egg 11451（如有型號則：iPhone 13／iOS 222／...）
    const getIOS = () => {
        const model = (document.getElementById("ios-model").value || "").trim();
        const osVal = (document.getElementById("ios-os").value || "").trim();

        const browsers = [];
        if (document.getElementById("ios-safari").checked) {
            const v = (document.getElementById("ios-safari-version").value || "").trim();
            browsers.push(v ? `Safari ${v}` : "Safari");
        }
        if (document.getElementById("ios-chrome").checked) {
            const v = (document.getElementById("ios-chrome-version").value || "").trim();
            browsers.push(v ? `Chrome ${v}` : "Chrome");
        }
        const on = (document.getElementById("ios-other-name").value || "").trim();
        const ov = (document.getElementById("ios-other-version").value || "").trim();
        if (on || ov) browsers.push(`${on || "其他"}${ov ? " " + ov : ""}`.trim());

        const platform = osVal ? `iOS ${osVal}` : "iOS";

        const parts = [];
        if (model) parts.push(model);
        parts.push(platform);
        if (browsers.length) parts.push(browsers.join("、"));

        return joinSlash(parts);
    };

    // 無選擇：略過整段（由呼叫端處理）
    if (!total) return lines;

    // 單選：若是 Android / iOS，使用「．手機：...」單行；若是 PC，使用「．PC：...」單行
    if (total === 1) {
        if (androidOn) {
            lines.push(`．手機：${getAndroid()}`);
            return lines;
        }
        if (iosOn) {
            lines.push(`．手機：${getIOS()}`);
            return lines;
        }
        if (pcOn) {
            const pc = getPC();
            lines.push(pc ? `．PC：${pc}` : "．PC");
            return lines;
        }
    }

    // 多選：PC 單列；手機依選擇數決定呈現（單選手機＝單行；Android+iOS＝群組巢狀）
    if (pcOn) {
        const pc = getPC();
        lines.push(pc ? `．PC：${pc}` : "．PC");
    }

    // 手機只有單選（不論是否同時有 PC）→ 單行呈現：．手機：iOS ... / Android ...
    if ((androidOn || iosOn) && !(androidOn && iosOn)) {
        if (androidOn) lines.push(`．手機：${getAndroid()}`);
        if (iosOn) lines.push(`．手機：${getIOS()}`);
        return lines;
    }

    // Android + iOS 同時勾選 → 手機群組巢狀條列
    if (androidOn && iosOn) {
        lines.push("．手機：");
        lines.push(`　．${getAndroid()}`);
        lines.push(`　．${getIOS()}`);
    }

    return lines;
}

/* --- 預覽內容更新 --- */

// ✅ 同步「每站別版本」DOM → window.siteConfigs（保險用）
function syncSiteVersionsFromDOM(){
    const sites = (window.selectedSites || []);
    sites.forEach(siteName => {
        const card = document.querySelector(`.site-config-card[data-site="${siteName}"]`);
        if(!card) return;
        const cfg = normSiteCfg(siteName);

        const gameChk = card.querySelector(`input[type="checkbox"][data-site="${siteName}"][data-vkey="gameEnabled"]`);
        const betChk  = card.querySelector(`input[type="checkbox"][data-site="${siteName}"][data-vkey="betEnabled"]`);
        const gameInp = card.querySelector(`input[type="text"][data-site="${siteName}"][data-vkey="game"]`);
        const betInp  = card.querySelector(`input[type="text"][data-site="${siteName}"][data-vkey="bet"]`);

        if(gameChk) cfg.versions.gameEnabled = !!gameChk.checked;
        if(betChk)  cfg.versions.betEnabled  = !!betChk.checked;
        if(gameInp) cfg.versions.game        = (gameInp.value || "").trim();
        if(betInp)  cfg.versions.bet         = (betInp.value || "").trim();

        if (siteName === "試玩模式") {
            cfg.versions.betEnabled = false;
            cfg.versions.bet = "";
        }
    });
}

function updateFullPreview(){
    const date = document.getElementById("incident_date").value;
    const tester = document.getElementById("tester").value;
    const selectedSitesList = (window.selectedSites || []);
    const siteConfigs = (window.siteConfigs || {});
    const orderRaw = document.getElementById("order_id").value.trim();

    // ✅ 保險：同步每站別版本（避免瀏覽器自動回填 input 但未觸發 input 事件）
    syncSiteVersionsFromDOM();

    const op = document.getElementById("operation_editor").innerText.trim();
    const act = document.getElementById("actual_editor").innerText.trim();
    const exp = document.getElementById("expected_editor").innerText.trim();
    const remark = document.getElementById("remark_editor").innerText.trim();

    const lines = [];

    // Header
    lines.push(`發生時間：${date}`);
    lines.push(`測試者：${tester}`);
    lines.push(`站別：${selectedSitesList.length ? selectedSitesList.join("、") : "-"}`);
    lines.push("");

    // 測試廳主／帳號 & 版本（單站別：不重複站別名；複數站別：站別底下巢狀條列）
    if (selectedSitesList.length === 0) {
        lines.push("測試廳主／帳號：");
        lines.push("．-");
        lines.push("");

        lines.push("版本：");
        lines.push("．-");
        lines.push("");
    } else if (selectedSitesList.length === 1) {
        const siteName = selectedSitesList[0];
        const cfg = siteConfigs[siteName] || { halls: [], pairs: [], versions: {} };

        // 測試廳主／帳號
        lines.push("測試廳主／帳號：");
        if (siteName === "試玩模式") {
            const halls = (cfg.halls && cfg.halls.length) ? cfg.halls : [];
            if (halls.length) halls.forEach(h => lines.push(`．${h}`));
            else lines.push("．-");
        } else {
            const pairs = (cfg.pairs && cfg.pairs.length) ? cfg.pairs : [];
            if (pairs.length) pairs.forEach(p => lines.push(`．${p.hall}／${p.account}`));
            else lines.push("．-");
        }
        lines.push("");

        // 版本
        lines.push("版本：");
        {
            const v = cfg.versions || {};
            let hasAny = false;

            if (v.gameEnabled) {
                const val = String(v.game || "").trim();
                lines.push(`．遊戲版本：${val || "-"}`);
                hasAny = true;
            }
            if (siteName !== "試玩模式" && v.betEnabled) {
                const val = String(v.bet || "").trim();
                lines.push(`．投注歷程版本：${val || "-"}`);
                hasAny = true;
            }

            if (!hasAny) lines.push("．-");
        }
        lines.push("");
    } else {
        // 複數站別：站別底下巢狀條列
        lines.push("測試廳主／帳號：");
        selectedSitesList.forEach(siteName => {
            const cfg = siteConfigs[siteName] || { halls: [], pairs: [], versions: {} };
            lines.push(`．${siteName}：`);

            if (siteName === "試玩模式") {
                const halls = (cfg.halls && cfg.halls.length) ? cfg.halls : [];
                if (halls.length) halls.forEach(h => lines.push(`　．${h}`));
                else lines.push("　．-");
            } else {
                const pairs = (cfg.pairs && cfg.pairs.length) ? cfg.pairs : [];
                if (pairs.length) pairs.forEach(p => lines.push(`　．${p.hall}／${p.account}`));
                else lines.push("　．-");
            }
        });
        lines.push("");

        // 版本（複選：站別底下再條列）
        lines.push("版本：");
        selectedSitesList.forEach(siteName => {
            const cfg = siteConfigs[siteName] || {};
            const v = cfg.versions || {};

            lines.push(`．${siteName}：`);

            const parts = [];
            if (v.gameEnabled) {
                const val = String(v.game || "").trim();
                parts.push(`　．遊戲版本：${val || "-"}`);
            }
            if (siteName !== "試玩模式" && v.betEnabled) {
                const val = String(v.bet || "").trim();
                parts.push(`　．投注歷程版本：${val || "-"}`);
            }

            if (parts.length) parts.forEach(p => lines.push(p));
            else lines.push("　．-");
        });
        lines.push("");
    }

    // 裝置（空內容整段略過）
    const deviceLines = getDeviceLines();
    if (deviceLines.length) {
        lines.push("裝置：");
        deviceLines.forEach(l => lines.push(l));
        lines.push("");
    }

    // 注單編號（空內容整段略過）
    if (orderRaw) {
        lines.push(`注單編號：${orderRaw}`);
        lines.push("");
    }

    // 操作 / 實際結果 / 預期結果（保留段落結構，段落間固定空一行）
    lines.push("操作：");
    if (op) lines.push(op);
    lines.push("");

    lines.push("實際結果：");
    if (act) lines.push(act);
    lines.push("");

    lines.push("預期結果：");
    if (exp) lines.push(exp);

    if (remark) {
        lines.push("");
        lines.push("備註：");
        lines.push(remark);
    }

    document.getElementById("full-preview").value = toFullWidthSymbols(lines.join("\n"));
}

/* --- 複製 --- */
document.getElementById("copy-title-btn").addEventListener("click",()=>{
    navigator.clipboard.writeText(document.getElementById("title-preview").value);
    alert("標題已複製！");
});
document.getElementById("copy-btn").addEventListener("click",()=>{
    navigator.clipboard.writeText(document.getElementById("full-preview").value);
    alert("全文已複製（不含標題）！");
});

/* --- 自訂記憶 autocomplete --- */
function loadMemory(key){ try{return JSON.parse(localStorage.getItem(key))||[]}catch{return[]} }
function saveMemory(key,arr){ localStorage.setItem(key,JSON.stringify(arr)); }

function setupMemoryField(id,key){
    const input=document.getElementById(id);
    const wrap=input.closest(".autocomplete-wrapper");
    const box=wrap.querySelector(".suggestions");
    let list=loadMemory(key);

    function render(filter=""){
        const kw=filter.toLowerCase();
        box.innerHTML="";

        const matches=list.filter(v=>v.toLowerCase().includes(kw));
        matches.forEach(v=>{
            const div=document.createElement("div");
            div.className="suggestion-item";
            div.textContent=v;
            div.addEventListener("mousedown",()=>{
                input.value=v;
                box.style.display="none";
                updateFullPreview();
            });
            box.appendChild(div);
        });

        box.style.display = matches.length ? "block":"none";
    }

    input.addEventListener("focus",()=>render(""));
    input.addEventListener("input",()=>render(input.value));

    input.addEventListener("blur",()=>{
        const v=input.value.trim();
        if(v && !list.includes(v)){
            list.push(v);
            saveMemory(key,list);
        }
        setTimeout(()=>box.style.display="none",120);
    });
}

// 供動態產生的 input 使用（例如：每站別版本欄位）
function setupMemoryFieldElement(input,key){
    if(!input || !key) return;
    const wrap=input.closest(".autocomplete-wrapper");
    if(!wrap) return;
    const box=wrap.querySelector(".suggestions");
    if(!box) return;
    let list=loadMemory(key);

    function render(filter=""){
        const kw=filter.toLowerCase();
        box.innerHTML="";
        const matches=list.filter(v=>v.toLowerCase().includes(kw));
        matches.forEach(v=>{
            const div=document.createElement("div");
            div.className="suggestion-item";
            div.textContent=v;
            div.addEventListener("mousedown",()=>{
                input.value=v;
                box.style.display="none";
                updateFullPreview();
            });
            box.appendChild(div);
        });
        box.style.display = matches.length ? "block":"none";
    }

    input.addEventListener("focus",()=>render(""));
    input.addEventListener("input",()=>render(input.value));
    input.addEventListener("blur",()=>{
        const v=input.value.trim();
        if(v && !list.includes(v)){
            list.push(v);
            saveMemory(key,list);
        }
        setTimeout(()=>box.style.display="none",120);
    });
}



/* --- autocomplete 站別搜尋（✅ 複選版；已選 chip 顯示在輸入框右側） --- */
const siteInput = document.getElementById("site-select");
const siteSuggest = document.getElementById("site-suggestions");

// ✅ 站別：僅選單（不允許文字輸入）
if (siteInput){
    siteInput.readOnly = true;
    siteInput.setAttribute("inputmode","none");
    siteInput.classList.add("menu-only");
    siteInput.addEventListener("keydown", (e)=>{
        if (e.key !== "Tab" && e.key !== "Shift") e.preventDefault();
    });
    siteInput.addEventListener("click", ()=> renderSiteList(""));
}

const siteList = ["測試站","正式站","開發站","試玩模式"];

window.selectedSites = window.selectedSites || [];
window.siteConfigs = window.siteConfigs || {}; // { [siteName]: {halls:[], pairs:[], versions:{...}} }

function normSiteCfg(siteName){
    if(!window.siteConfigs[siteName]){
        window.siteConfigs[siteName] = { halls: [], pairs: [], versions: { gameEnabled: false, game: "", betEnabled: false, bet: "" } };
    }
    const cfg = window.siteConfigs[siteName];
    if(!cfg.halls) cfg.halls = [];
    if(!cfg.pairs) cfg.pairs = [];
    if(!cfg.versions) cfg.versions = { gameEnabled: false, game: "", betEnabled: false, bet: "" };
    if(typeof cfg.versions.gameEnabled !== "boolean") cfg.versions.gameEnabled = false;
    if(typeof cfg.versions.betEnabled  !== "boolean") cfg.versions.betEnabled  = false;
    if(typeof cfg.versions.game !== "string") cfg.versions.game = "";
    if(typeof cfg.versions.bet  !== "string") cfg.versions.bet  = "";

    // 舊版相容：若曾使用 accounts（已停用），嘗試轉為 pairs（以索引配對）
    if(cfg.accounts && Array.isArray(cfg.accounts) && cfg.accounts.length && (!cfg.pairs || !cfg.pairs.length)){
        const halls = Array.isArray(cfg.halls) ? cfg.halls : [];
        const accs  = cfg.accounts;
        const pairs = [];
        const n = Math.min(halls.length, accs.length);
        for(let i=0;i<n;i++){
            const h = (halls[i]||"").trim();
            const a = (accs[i]||"").trim();
            if(h && a) pairs.push({ hall: h, account: a });
        }
        cfg.pairs = pairs;
    }

    return cfg;
}

function renderSelectedSites(){
    const box = document.getElementById("selected-sites");
    box.innerHTML = "";

    window.selectedSites.forEach((s, idx) => {
        const chip = document.createElement("div");
        chip.className = "game-chip";
        chip.textContent = s;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "×";
        btn.addEventListener("click", () => {
            window.selectedSites.splice(idx, 1);
            // 同步刪除設定
            delete window.siteConfigs[s];
            renderSelectedSites();
            renderSiteConfigBlocks();
            updateFullPreview();
        });

        chip.appendChild(btn);
        box.appendChild(chip);
    });
}

function renderSiteList(keyword=""){
    const kw = keyword.trim().toLowerCase();
    siteSuggest.innerHTML = "";

    // 清除全部
    const clearDiv = document.createElement("div");
    clearDiv.className = "suggestion-item";
    clearDiv.textContent = "(清除全部)";
    clearDiv.addEventListener("mousedown", () => {
        window.selectedSites = [];
        window.siteConfigs = {};
        siteInput.value = "";
        renderSelectedSites();
        renderSiteConfigBlocks();
        siteSuggest.style.display = "none";
        updateFullPreview();
    });
    siteSuggest.appendChild(clearDiv);

    const matches = siteList.filter(s => s.toLowerCase().includes(kw));
    matches.forEach((s) => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = s;
        div.addEventListener("mousedown", () => {
            // 試玩模式：保持互斥（只留它）
            if (s === "試玩模式") {
                window.selectedSites = ["試玩模式"];
                window.siteConfigs = { "試玩模式": normSiteCfg("試玩模式") };
            } else {
                // 若目前是試玩模式，先移除
                window.selectedSites = window.selectedSites.filter(x => x !== "試玩模式");
                if (!window.selectedSites.includes(s)) window.selectedSites.push(s);
                normSiteCfg(s);
            }

            siteInput.value = "";
            renderSelectedSites();
            renderSiteConfigBlocks();
            siteSuggest.style.display = "none";
            updateFullPreview();
        });
        siteSuggest.appendChild(div);
    });

    siteSuggest.style.display = matches.length ? "block" : "none";
}

siteInput.addEventListener("focus", () => renderSiteList(""));
siteInput.addEventListener("input", () => renderSiteList(siteInput.value));
document.addEventListener("click", (e) => {
    if (!siteInput.contains(e.target)) siteSuggest.style.display = "none";
});

/* --- 各站別：廳主／帳號（可搜尋複選） --- */
const HALL_OPTIONS = ["Tidy遊戲商測試廳","Tidy遊戲級距測試廳","DB TEST"]; // 可自行擴充

function makeMultiSelect({
    container,
    options,
    placeholder,
    getSelected,
    setSelected,
    memoryKey
}){
    const wrap = document.createElement("div");
    wrap.className = "autocomplete-wrapper";

    const input = document.createElement("input");
    input.type = "text";
    input.autocomplete = "new-password";
    input.placeholder = placeholder;

    const sugg = document.createElement("div");
    sugg.className = "suggestions";

    const selectedBox = document.createElement("div");
    selectedBox.style.display = "flex";
    selectedBox.style.flexWrap = "wrap";
    selectedBox.style.gap = "4px";
    selectedBox.style.minHeight = "34px";
    selectedBox.style.visibility = "hidden";
    selectedBox.style.marginTop = "1px";

    wrap.appendChild(input);
    wrap.appendChild(sugg);

    container.appendChild(wrap);
    container.appendChild(selectedBox);

    let memList = [];
    if (memoryKey){
        try{ memList = JSON.parse(localStorage.getItem(memoryKey)) || []; }catch{ memList=[]; }
    }

    function saveMem(v){
        if(!memoryKey) return;
        if(v && !memList.includes(v)){
            memList.push(v);
            localStorage.setItem(memoryKey, JSON.stringify(memList));
        }
    }

    function renderSelected(){
        selectedBox.innerHTML = "";
        getSelected().forEach((v, idx) => {
            const chip = document.createElement("div");
            chip.className = "game-chip";
            chip.textContent = v;
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = "×";
            btn.addEventListener("click", () => {
                const arr = getSelected().slice();
                arr.splice(idx, 1);
                setSelected(arr);
                renderSelected();
                updateFullPreview();
            });
            chip.appendChild(btn);
            selectedBox.appendChild(chip);
        });
        // ✅ 預留高度但避免空白太突兀：沒選項時先隱藏（仍保留高度）
        selectedBox.style.visibility = getSelected().length ? "visible" : "hidden";
    }

    function renderSuggest(filter=""){
        const kw = filter.trim().toLowerCase();
        sugg.innerHTML = "";

        const all = (options || []).concat(memList);
        const uniq = Array.from(new Set(all));
        const matches = uniq.filter(v => v.toLowerCase().includes(kw));

        // 清除全部
        const clearDiv = document.createElement("div");
        clearDiv.className = "suggestion-item";
        clearDiv.textContent = "(清除全部)";
        clearDiv.addEventListener("mousedown", () => {
            setSelected([]);
            input.value = "";
            sugg.style.display = "none";
            renderSelected();
            updateFullPreview();
        });
        sugg.appendChild(clearDiv);

        matches.forEach(v => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.textContent = v;
            div.addEventListener("mousedown", () => {
                const arr = getSelected().slice();
                if(!arr.includes(v)) arr.push(v);
                setSelected(arr);
                input.value = "";
                renderSelected();
                sugg.style.display = "none";
                saveMem(v);
                updateFullPreview();
            });
            sugg.appendChild(div);
        });

        sugg.style.display = matches.length ? "block" : "none";
    }

    input.addEventListener("focus", () => renderSuggest(""));
    input.addEventListener("input", () => renderSuggest(input.value));

    // 允許直接輸入 Enter 加入（適用帳號）
    input.addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
            const v = input.value.trim();
            if(v){
                const arr = getSelected().slice();
                if(!arr.includes(v)) arr.push(v);
                setSelected(arr);
                input.value = "";
                renderSelected();
                saveMem(v);
                sugg.style.display = "none";
                updateFullPreview();
            }
            e.preventDefault();
        }
    });

    document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target)) sugg.style.display = "none";
    });

    renderSelected();
    return { renderSelected };
}

function renderSiteConfigBlocks(){
    const host = document.getElementById("site-config-container");
    if(!host) return;
    host.innerHTML = "";

    window.selectedSites.forEach(siteName => {
        const cfg = normSiteCfg(siteName);

        const card = document.createElement("div");
        card.className = "site-config-card";
        card.dataset.site = siteName;

        const header = document.createElement("div");
        header.className = "site-config-header";
        const title = document.createElement("div");
        title.className = "site-config-title";
        title.textContent = siteName;
        header.appendChild(title);
        card.appendChild(header);

        // 試玩模式：邏輯保持（只選廳主，可複選；仍可填版本），但 UI／版面比照其他站別膠囊
        if (siteName === "試玩模式") {
            const rowPair = document.createElement("div");
            rowPair.className = "site-config-row";
            const fieldPair = document.createElement("div");
            fieldPair.className = "field";
            rowPair.appendChild(fieldPair);
            card.appendChild(rowPair);

            const addLine = document.createElement("div");
            addLine.className = "pair-add-line";

            // --- 單選廳主 input（autocomplete）---
            const hallWrap = document.createElement("div");
            hallWrap.className = "autocomplete-wrapper pair-hall-wrap";
            const hallInput = document.createElement("input");
            hallInput.type = "text";
            hallInput.autocomplete = "new-password";
            hallInput.placeholder = "選擇廳主";
            hallInput.readOnly = true;
            hallInput.setAttribute("inputmode","none");
            hallInput.classList.add("menu-only");
            const hallSugg = document.createElement("div");
            hallSugg.className = "suggestions";
            hallWrap.appendChild(hallInput);
            hallWrap.appendChild(hallSugg);

            // --- 佔位：對齊其他站別的「帳號欄」寬度（試玩模式不需要帳號）---
            const dummyWrap = document.createElement("div");
            dummyWrap.className = "autocomplete-wrapper pair-account-wrap trial-empty";
            const dummyInput = document.createElement("input");
            dummyInput.type = "text";
            dummyInput.disabled = true;
            dummyInput.tabIndex = -1;
            dummyWrap.appendChild(dummyInput);

            const addBtn = document.createElement("button");
            addBtn.type = "button";
            addBtn.className = "pair-add-btn";
            addBtn.textContent = "加入";

            addLine.appendChild(hallWrap);
            addLine.appendChild(dummyWrap);
            addLine.appendChild(addBtn);

            const chipBox = document.createElement("div");
            chipBox.className = "selected-chips";
            chipBox.style.visibility = "hidden";
            chipBox.style.marginTop = "2px";

            fieldPair.appendChild(addLine);
            fieldPair.appendChild(chipBox);

            const renderHalls = () => {
                chipBox.innerHTML = "";
                const halls = cfg.halls || [];
                // ✅ 預留高度避免加入第一顆 chip 時推擠卡片
                chipBox.style.visibility = halls.length ? "visible" : "hidden";
                halls.forEach((h, idx) => {
                    const chip = document.createElement("div");
                    chip.className = "game-chip";
                    chip.textContent = h;
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.textContent = "×";
                    btn.addEventListener("click", () => {
                        const arr = (cfg.halls || []).slice();
                        arr.splice(idx, 1);
                        cfg.halls = arr;
                        renderHalls();
                        updateFullPreview();
                    });
                    chip.appendChild(btn);
                    chipBox.appendChild(chip);
                });
            };

            const renderHallSuggest = (filter="") => {
                const kw = filter.trim().toLowerCase();
                hallSugg.innerHTML = "";
                const matches = (HALL_OPTIONS||[]).filter(v => v.toLowerCase().includes(kw));
                matches.forEach(v => {
                    const div = document.createElement("div");
                    div.className = "suggestion-item";
                    div.textContent = v;
                    div.addEventListener("mousedown", () => {
                        hallInput.value = v;
                        hallSugg.style.display = "none";
                    });
                    hallSugg.appendChild(div);
                });
                hallSugg.style.display = matches.length ? "block" : "none";
            };

            const addHall = () => {
                const hall = hallInput.value.trim();
                if(!hall){
                    alert('請先選擇廳主');
                    return;
                }
                const arr = (cfg.halls || []).slice();
                if(!arr.includes(hall)) arr.push(hall);
                cfg.halls = arr;
                hallInput.value = "";
                renderHalls();
                updateFullPreview();
            };

            addBtn.addEventListener("click", addHall);
            hallInput.addEventListener("focus", () => renderHallSuggest(""));
            // hallInput 為 menu-only，不需要 input 過濾（保留以防未來需求）
            hallInput.addEventListener("input", () => renderHallSuggest(hallInput.value));
            hallInput.addEventListener("keydown", (e) => {
                if(e.key === "Enter"){
                    addHall();
                    e.preventDefault();
                    return;
                }
                if (e.key !== "Tab" && e.key !== "Shift") e.preventDefault();
            });
            document.addEventListener("click", (e) => {
                if (!hallWrap.contains(e.target)) hallSugg.style.display = "none";
            });

            renderHalls();

            // 試玩模式不使用『投注歷程版本』：強制關閉並清空（避免舊值影響輸出）
            cfg.versions.betEnabled = false;
            cfg.versions.bet = "";

            // --- 版本（每站別各自設定；試玩模式也需要；預留高度避免推擠）---
            const vBlock = document.createElement("div");
            vBlock.className = "site-version-block";

            const makeVersionLine = (text, enabledKey, valueKey, memKey, placeholder) => {
                const line = document.createElement("div");
                line.className = "site-version-line";

                const lab = document.createElement("label");
                const chk = document.createElement("input");
                chk.type = "checkbox";
                chk.checked = !!cfg.versions[enabledKey];
                chk.dataset.site = siteName;
                chk.dataset.vkey = enabledKey;
                lab.appendChild(chk);
                lab.appendChild(document.createTextNode(" " + text));

                const wrap = document.createElement("div");
                wrap.className = "autocomplete-wrapper";
                if(!chk.checked) wrap.classList.add("v-hidden");

                const inp = document.createElement("input");
                inp.type = "text";
                inp.autocomplete = "new-password";
                inp.placeholder = placeholder;
                inp.value = (cfg.versions[valueKey] || "");
                inp.dataset.site = siteName;
                inp.dataset.vkey = valueKey;

                const sugg = document.createElement("div");
                sugg.className = "suggestions";

                wrap.appendChild(inp);
                wrap.appendChild(sugg);

                inp.disabled = !chk.checked;

                chk.addEventListener("change", () => {
                    cfg.versions[enabledKey] = chk.checked;
                    wrap.classList.toggle("v-hidden", !chk.checked);
                    inp.disabled = !chk.checked;
                    updateFullPreview();
                });
                inp.addEventListener("input", () => {
                    cfg.versions[valueKey] = inp.value;
                    updateFullPreview();
                });

                setupMemoryFieldElement(inp, memKey);

                line.appendChild(lab);
                line.appendChild(wrap);
                return line;
            };

            vBlock.appendChild(
                makeVersionLine(
                    "遊戲版本",
                    "gameEnabled",
                    "game",
                    `version_game_${siteName}`,
                    "輸入遊戲版本號碼"
                )
            );
            fieldPair.appendChild(vBlock);
        } else {
            // 其他站別：廳主 ↔ 帳號（1 對 1 綁定），以「配對」方式加入
            const rowPair = document.createElement("div");
            rowPair.className = "site-config-row";
            const fieldPair = document.createElement("div");
            fieldPair.className = "field";
            rowPair.appendChild(fieldPair);
            card.appendChild(rowPair);

            const addLine = document.createElement("div");
            addLine.className = "pair-add-line";

            // --- 單選廳主 input（autocomplete） ---
            const hallWrap = document.createElement("div");
            hallWrap.className = "autocomplete-wrapper pair-hall-wrap";
            const hallInput = document.createElement("input");
            hallInput.type = "text";
            hallInput.autocomplete = "new-password";
            hallInput.placeholder = "選擇廳主";
            hallInput.readOnly = true;
            hallInput.setAttribute("inputmode","none");
            hallInput.classList.add("menu-only");
            const hallSugg = document.createElement("div");
            hallSugg.className = "suggestions";
            hallWrap.appendChild(hallInput);
            hallWrap.appendChild(hallSugg);

            // --- 單選/輸入帳號 input（autocomplete + memory） ---
            const accWrap = document.createElement("div");
            accWrap.className = "autocomplete-wrapper pair-account-wrap";
            const accInput = document.createElement("input");
            accInput.type = "text";
            accInput.autocomplete = "new-password";
            accInput.placeholder = "輸入/搜尋帳號";
            const accSugg = document.createElement("div");
            accSugg.className = "suggestions";
            accWrap.appendChild(accInput);
            accWrap.appendChild(accSugg);

            const addBtn = document.createElement("button");
            addBtn.type = "button";
            addBtn.className = "pair-add-btn";
            addBtn.textContent = "加入";

            addLine.appendChild(hallWrap);
            addLine.appendChild(accWrap);
            addLine.appendChild(addBtn);

            const chipBox = document.createElement("div");
            chipBox.className = "selected-chips";
            chipBox.style.visibility = "hidden";
            chipBox.style.marginTop = "2px";

            fieldPair.appendChild(addLine);
            fieldPair.appendChild(chipBox);

            // --- 版本（每站別各自設定；試玩模式不顯示） ---
            const vBlock = document.createElement("div");
            vBlock.className = "site-version-block";

            const makeVersionLine = (text, enabledKey, valueKey, memKey, placeholder) => {
                const line = document.createElement("div");
                line.className = "site-version-line";

                const lab = document.createElement("label");
                const chk = document.createElement("input");
                chk.type = "checkbox";
                chk.checked = !!cfg.versions[enabledKey];
                // 標記：供輸出時同步 DOM 內容
                chk.dataset.site = siteName;
                chk.dataset.vkey = enabledKey;
                lab.appendChild(chk);
                lab.appendChild(document.createTextNode(" " + text));

                const wrap = document.createElement("div");
                wrap.className = "autocomplete-wrapper";
                // ✅ 永遠保留佔位：用 visibility 來隱藏，避免勾選後整個膠囊被推擠
                if(!chk.checked) wrap.classList.add("v-hidden");

                const inp = document.createElement("input");
                inp.type = "text";
                inp.autocomplete = "new-password";
                inp.placeholder = placeholder;
                inp.value = (cfg.versions[valueKey] || "");
                // 標記：供輸出時同步 DOM 內容
                inp.dataset.site = siteName;
                inp.dataset.vkey = valueKey;

                const sugg = document.createElement("div");
                sugg.className = "suggestions";

                wrap.appendChild(inp);
                wrap.appendChild(sugg);

                // 初始狀態：未勾選時避免 tab 進入隱藏欄位
                inp.disabled = !chk.checked;

                chk.addEventListener("change", () => {
                    cfg.versions[enabledKey] = chk.checked;
                    wrap.classList.toggle("v-hidden", !chk.checked);
                    inp.disabled = !chk.checked;
                    updateFullPreview();
                });
                inp.addEventListener("input", () => {
                    cfg.versions[valueKey] = inp.value;
                    updateFullPreview();
                });

                // autocomplete + localStorage memory
                setupMemoryFieldElement(inp, memKey);

                line.appendChild(lab);
                line.appendChild(wrap);
                return line;
            };

            vBlock.appendChild(
                makeVersionLine(
                    "遊戲版本",
                    "gameEnabled",
                    "game",
                    `version_game_${siteName}`,
                    "輸入遊戲版本號碼"
                )
            );
            vBlock.appendChild(
                makeVersionLine(
                    "投注歷程版本",
                    "betEnabled",
                    "bet",
                    `version_bet_${siteName}`,
                    "輸入投注歷程版本號碼"
                )
            );

            fieldPair.appendChild(vBlock);

            // memory list for accounts
            const accMemKey = `account_${siteName}`;
            let accMem = [];
            try { accMem = JSON.parse(localStorage.getItem(accMemKey)) || []; } catch { accMem = []; }
            const saveAccMem = (v) => {
                if(!v) return;
                if(!accMem.includes(v)) {
                    accMem.push(v);
                    localStorage.setItem(accMemKey, JSON.stringify(accMem));
                }
            };

            const renderHallSuggest = (filter="") => {
                const kw = filter.trim().toLowerCase();
                hallSugg.innerHTML = "";
                const matches = (HALL_OPTIONS||[]).filter(v => v.toLowerCase().includes(kw));
                matches.forEach(v => {
                    const div = document.createElement("div");
                    div.className = "suggestion-item";
                    div.textContent = v;
                    div.addEventListener("mousedown", () => {
                        hallInput.value = v;
                        hallSugg.style.display = "none";
                    });
                    hallSugg.appendChild(div);
                });
                hallSugg.style.display = matches.length ? "block" : "none";
            };

            const renderAccSuggest = (filter="") => {
                const kw = filter.trim().toLowerCase();
                accSugg.innerHTML = "";
                const uniq = Array.from(new Set(accMem));
                const matches = uniq.filter(v => v.toLowerCase().includes(kw));
                matches.forEach(v => {
                    const div = document.createElement("div");
                    div.className = "suggestion-item";
                    div.textContent = v;
                    div.addEventListener("mousedown", () => {
                        accInput.value = v;
                        accSugg.style.display = "none";
                    });
                    accSugg.appendChild(div);
                });
                accSugg.style.display = matches.length ? "block" : "none";
            };

            const renderPairs = () => {
                chipBox.innerHTML = "";
                const pairs = cfg.pairs || [];
                // ✅ 預留高度避免加入第一顆 chip 時推擠卡片
                chipBox.style.visibility = pairs.length ? "visible" : "hidden";
                pairs.forEach((p, idx) => {
                    const chip = document.createElement("div");
                    chip.className = "game-chip";
                    chip.textContent = `${p.hall}／${p.account}`;
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.textContent = "×";
                    btn.addEventListener("click", () => {
                        const arr = (cfg.pairs || []).slice();
                        arr.splice(idx, 1);
                        cfg.pairs = arr;
                        renderPairs();
                        updateFullPreview();
                    });
                    chip.appendChild(btn);
                    chipBox.appendChild(chip);
                });
            };

            const addPair = () => {
                const hall = hallInput.value.trim();
                const acc  = accInput.value.trim();
                if(!hall || !acc){
                    alert('請先選擇廳主並輸入帳號');
                    return;
                }
                const arr = (cfg.pairs || []).slice();
                const i = arr.findIndex(x => x.hall === hall);
                if(i >= 0){
                    // 一個廳主只能綁一個帳號：直接更新為新帳號
                    arr[i] = { hall, account: acc };
                } else {
                    arr.push({ hall, account: acc });
                }
                cfg.pairs = arr;
                saveAccMem(acc);
                hallInput.value = "";
                accInput.value  = "";
                renderPairs();
                updateFullPreview();
            };

            addBtn.addEventListener("click", addPair);

            hallInput.addEventListener("focus", () => renderHallSuggest(""));
            // hallInput 為 menu-only，不需要 input 過濾（保留以防未來需求）
            hallInput.addEventListener("input", () => renderHallSuggest(hallInput.value));
            hallInput.addEventListener("keydown", (e) => {
                if (e.key !== "Tab" && e.key !== "Shift") e.preventDefault();
            });

            accInput.addEventListener("focus", () => renderAccSuggest(""));
            accInput.addEventListener("input", () => renderAccSuggest(accInput.value));

            accInput.addEventListener("keydown", (e) => {
                if(e.key === "Enter"){
                    addPair();
                    e.preventDefault();
                }
            });

            document.addEventListener("click", (e) => {
                if (!hallWrap.contains(e.target)) hallSugg.style.display = "none";
                if (!accWrap.contains(e.target))  accSugg.style.display  = "none";
            });

            renderPairs();
        }

        host.appendChild(card);
    });
}

/* --- 初始化 --- */
window.addEventListener("DOMContentLoaded",()=>{
    setToday();

    // 自動同步 iOS OS 版本到 Safari 欄位
    document.getElementById("ios-os").addEventListener("input", () => {
        const os = document.getElementById("ios-os").value.trim();
        document.getElementById("ios-safari-version").value = os;
    });

    // 記憶欄位
    setupMemoryField("tester","tester");
    setupMemoryField("android-model","android_model");
    setupMemoryField("ios-model","ios_model");

    // 站別初始渲染
    renderSelectedSites();
    renderSiteConfigBlocks();

    // 控制 iOS 子欄位顯示
    const syncIosBlock = () => {
        const ios = document.getElementById("ios-check").checked;
        document.getElementById("ios-browser-wrapper").style.display = ios ? "flex" : "none";
    };
    syncIosBlock();
    document.querySelectorAll(".device-check").forEach(chk=>{
        chk.addEventListener("change",()=>{
            syncIosBlock();
            updateFullPreview();
        });
    });

    // iOS 子瀏覽器更新
    document.querySelectorAll(".ios-browser").forEach(chk=>{
        chk.addEventListener("change",updateFullPreview);
    });

    // 基本欄位
    [
        "incident_date","order_id",
        "problem-desc",
        "operation_editor","actual_editor","expected_editor","remark_editor"
    ].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener("input", ()=>{
            if(id === "problem-desc") updateTitle();
            updateFullPreview();
        });
    });

    // 裝置欄位
    [
        "pc-browser",
        "android-model","android-os","android-browser",
        "ios-os","ios-model",
        "ios-safari-version","ios-chrome-version",
        "ios-other-name","ios-other-version"
    ].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.addEventListener("input",updateFullPreview);
    });

    updateTitle();
    updateFullPreview();
});
</script>

</body>
</html>
